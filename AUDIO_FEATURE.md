# 🎵 音频功能说明

## 功能概述

现在可视化器支持**音频播放**！当音符到达红色播放线时，会自动播放对应的钢琴音色。

## ✨ 新增功能

### 🎹 钢琴音色合成
- 使用 **Web Audio API** 实时合成钢琴音色
- 基音 + 泛音组合，模拟真实钢琴音色
- ADSR 包络（Attack-Decay-Sustain-Release）

### 🔊 音频控制
- **音频开关**: 勾选 "Enable Sound" 启用音频
- **音量调节**: 0-100% 可调
- **智能触发**: 音符到达播放线时自动播放
- **延音踏板**: 点击 "Sustain Pedal" 按钮启用/禁用延音效果

### 🎮 使用方法

1. **启用音频**
   - 在控制面板找到 "Audio" 部分
   - 勾选 "🔊 Enable Sound"
   - 调整音量滑块（默认30%）

2. **开始播放**
   - 点击 "▶ Play" 按钮
   - 音符向下滚动
   - 当音符碰到红色线时，会听到对应音高

3. **练习指法**
   - 使用慢速（0.5x）练习
   - 听到声音 + 看到指法数字
   - 强化肌肉记忆

## 🔧 技术实现

### 音频引擎架构

```javascript
class PianoAudioEngine {
    // Web Audio API
    audioContext: AudioContext

    // 音色配置
    config: {
        masterGain: 0.3,      // 主音量
        attackTime: 0.01,     // 起音时间
        decayTime: 0.1,       // 衰减时间
        sustainLevel: 0.7,    // 延音水平
        releaseTime: 0.3,     // 释音时间
        harmonicStrength: 0.3 // 泛音强度
    }

    // 方法
    playNote(midiNote, duration)
    createPianoTone(frequency, output, duration)
    triggerNote(noteId, midiNote, duration)
}
```

### 音色合成

每个音符由多个振荡器组成：

1. **基音**
   - 正弦波 (60% 强度)
   - 三角波 (30% 强度)

2. **泛音系列**
   - 第2泛音 (2倍频)
   - 第3泛音 (3倍频)
   - 第4泛音 (4倍频)
   - 第5泛音 (5倍频)

### 音符触发逻辑

```javascript
triggerAudio() {
    // 检查所有音符
    allNotes.forEach(note => {
        // 如果音符在时间窗口内（到达播放线）
        if (note.time >= lastPlayedTime &&
            note.time < currentTime + timeWindow) {

            // 播放音符（使用唯一ID防止重复）
            const noteId = `${note.pitch}_${note.time}`;
            audioEngine.triggerNote(noteId, note.pitch, note.duration);
        }
    });
}
```

## 🎯 音色参数调优

当前参数经过优化，适合大多数场景：

| 参数 | 值 | 说明 |
|------|-----|------|
| Attack | 0.01s | 快速起音，类似钢琴琴槌敲击 |
| Decay | 0.1s | 快速衰减到延音水平 |
| Sustain | 70% | 保持音量 |
| Release | 0.3s | 平滑释音 |

如需自定义，可修改 `audio-engine.js` 中的 `this.config` 对象。

## 💡 使用技巧

### 1. 初学者练习
```
速度: 0.5x
音量: 50%
音频: ✅ 启用
```
- 有充足时间准备手指
- 听到声音确认按键准确
- 建立正确的手型

### 2. 进阶练习
```
速度: 1.0x
音量: 40%
音频: ✅ 启用
```
- 正常速度演奏
- 音量适中，不干扰思考
- 专注流畅性

### 3. 快速预览
```
速度: 1.5x
音量: 60%
音频: ✅ 启用
```
- 快速浏览乐曲
- 听到整体旋律
- 识别难点段落

### 4. 延音踏板练习
```
速度: 0.75x
音量: 40%
音频: ✅ 启用
延音踏板: ✅ 启用
```
- 练习连贯性
- 音符之间平滑过渡
- 模拟真实踏板效果

### 5. 静音练习
```
速度: 任意
音量: 任意
音频: ❌ 禁用
```
- 专注指法视觉
- 适合公共场合
- 减少听觉干扰

## 🎵 音频特性

### 延音踏板效果

踏板按下时:
- 音符释音时间延长到 2.0 秒（正常为 0.3 秒）
- 音符之间产生重叠和共鸣
- 模拟真实钢琴的延音踏板效果

踏板释放时:
- 所有延音音符快速释音（0.1秒）
- 清晰停止延音效果
- 避免声音混乱

### 音域范围
- 支持 MIDI 音高: 21-108 (A2 - C8)
- 频率范围: 27.5 Hz - 4186 Hz
- 完整覆盖88键钢琴

### 多音符支持
- 同时播放多个音符（和弦）
- 自动混合
- 防止爆音（增益控制）

### 性能优化
- 振荡器自动停止和清理
- 避免内存泄漏
- 平滑的包络过渡

## ⚠️ 注意事项

1. **浏览器兼容性**
   - 需要支持 Web Audio API
   - Chrome/Firefox/Safari/Edge 均支持
   - IE 不支持

2. **用户交互要求**
   - 首次播放需要用户交互（点击按钮）
   - 符合浏览器自动播放策略
   - 勾选音频开关时会激活 AudioContext

3. **性能建议**
   - 大量音符（>1000）可能影响性能
   - 可通过禁用音频提升性能
   - 移动设备建议降低音量

4. **音质 vs 性能**
   - 当前配置平衡音质和性能
   - 可减少泛音数量提升性能
   - 可增加泛音数量提升音质

## 🚀 未来改进

可能的增强功能：
- [ ] 更真实的钢琴音色（采样合成）
- [x] 延音踏板支持 ✅ 已实现
- [ ] 力度感应（根据速度调整音量）
- [ ] 混响效果
- [ ] 多种音色切换（电钢琴、风琴等）
- [ ] MIDI 键盘输入支持
- [ ] 柔音踏板（Una Corda）
- [ ] 选择性延音踏板（Sostenuto）

## 📝 更新日志

### v2.6 (延音踏板) - 2026-01-17
- ✨ 延音踏板功能
- ✅ 踏板开关按钮
- ✅ 延长释音时间（2.0秒）
- ✅ 踏板释放快速停止
- ✅ 视觉反馈（绿色高亮）

### v2.5 (音频功能) - 2026-01-17
- ✨ 钢琴音色合成
- ✅ 音频开关控制
- ✅ 音量调节
- ✅ 音符触发系统
- ✅ 滚动模式音频同步

享受你的钢琴练习！🎹🎵
